<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Babel: a Dictionary for Panhuman Image-Based Language</title>
		<script src="http://code.jquery.com/jquery-1.8.1.min.js"></script>
		<script src="js/mongoUtil.js"></script>
		<script src="js/less-1.3.0.min.js" type="text/javascript"></script>
		<link rel="stylesheet/less" type="text/css" href="css/babel.less" />
		<script>
		
			var term; //declare here so it can be used anywhere
		
			$(document).ready(function() {
				var filter_tweet = function(tweet) {
					var filter_patterns = [
							/(RT:?["'\s]{0,2})?(@[a-zA-Z\d_]+[:\s"']{1,3})?/g, //retweets
							/[:;][\-']?[\)\(\[\]\{\}\*oO0DpP]/g, //left to right emoticons
							/[D\(\)\[\]\{\}][\-']?[;:]/g, //right to left emoticons
							/((http|https)(:\/\/))?([a-zA-Z0-9]+[.]{1}){2}[a-zA-z0-9]+(\/{1}[a-zA-Z0-9]+)*\/?/g, //urls
							/([\"\'\(\[])*[a-zA-Z0-9:\,\.\']{2,}[\"\'\)\]]*\s?/g //standard words
						];
					for(var i=0; i<filter_patterns.length; i++) {
						tweet=tweet.replace(filter_patterns[i], '');
					}
					return tweet;
				}
				//Get tweets to find a dictionary term	
				if(localStorage.twitterSearch) {//twitterSearch is a property of localStorage; can be named anything
					var twitterData = JSON.parse(localStorage.twitterSearch), //converts back from strings
						formattedTweets = [];
					$.each(twitterData.results, function(index, tweet) {
						var id = tweet.id_str,
							text = tweet.text,
							author = tweet.from_user;
						formattedTweets.push({ //save only the data you want
							id: id,
							text: text,
							author: author
						});
					});
					localStorage.formattedTweets = JSON.stringify(formattedTweets); //Converts to string is can actually be saved in localStorage
					term = $.trim(filter_tweet(formattedTweets[0].text)); //uses formattedTweets (not localStorage) so you don't have to JSON.parse it
					//Layout alterations
					$('.term').append(term);
					$.each(formattedTweets, function(index, value) {
						var tweet = value.text,
							author = value.author,
							id = value.id,
							url = "http://twitter.com/"+author+"/status/"+id,
							contextBlock = "<li>"+tweet+" <a href='"+url+"' target='_blank'>âžš</a></li>";
						console.log(contextBlock);
						$('#contextContainer').append(contextBlock);
				});
				} else { //if the information does not exist in the cache, do this (add it, which is defined in the success property function)
					var data;
					$.ajax({
						url: 'http://search.twitter.com/search.json?q=%E3%82%B7%20OR%20%E3%81%A3%20OR%20%E3%83%8F%20OR%20%E3%81%A1%20OR%20(%E0%AB%80%20OR%20%E3%81%93%20OR%20%E0%B1%AA%20OR%20%E2%97%9E%E0%B8%B4%20OR%20%E2%97%9F%E0%B8%B4%20OR%20%E2%9A%97%E0%B8%B1%20lang%3Aen&rpp=1',
						dataType:'jsonp',
						success:function(response) {//has to be called "response"
							localStorage.twitterSearch = JSON.stringify(response); //response has to be wrapped in this to convert the object to a string
						},
						error: function(error){//should pass the actual error that was encountered
							console.log(error);
						}
					});	
				}
				//Get google images
				if(localStorage.imageSearch) {
					var imageResults = JSON.parse(localStorage.imageSearch),
						formattedImages = [];
					$.each(imageResults.items, function(index, value) {
						var imgUrl = value.link;
						formattedImages.push({
							imgUrl : imgUrl
						});
					});
					localStorage.formattedImages = JSON.stringify(formattedImages);
					$.each(formattedImages, function(index, value) {
						var imgUrl = value.imgUrl,
						defBlock = "<li><div></div><img src='"+imgUrl+"' /></li>";
						$('#defContainer').append(defBlock);
					});
				} else {
					$.ajax({
						url: 'https://www.googleapis.com/customsearch/v1?key=AIzaSyC3j0IL8MvOHlnJyxlvVBtV516H_GWm9w0&cx=013127619618331965896:basxoxgd-ce&q='+term+'&searchType=image', //figure out how to limit search results
						dataType:'jsonp',
						success:function(response){
							localStorage.imageSearch = JSON.stringify(response);
							console.log(response);
						}
					});
				}
			
				//MongoDB stuff
				mongoUtil.config({
					"db":"babeldb",
					"appID":"heroku_app7962868",
					"apiKey":"5089c368e4b0a116b09053b1"
				});
				mongoUtil.get();
				
				//Definition interaction scripts
				$('#defContainer > li > div').hide();			
				$('#defContainer > li').mouseenter(function() {
					jQuery(this).children('div').show();
				}).mouseleave(function() {
					jQuery(this).children('div').hide();
				}).click(function() {
					jQuery(this).remove();
				});
			});
		</script>
	</head>
	<body>
		<div id="navigation">
			<li><a href="#" class="active">Contribute</a></li>
			<li><a href="#">Search</a></li>
			<li><a href="#">View Current Dictionary</a></li>
			<li><a href="#">About</a></li>
			<form id="search">
				<input type="text" value="Search the dictionary" name="search" />
			</form>
		</div>
		<div id="container">
			<header>
				<a href="index.php"><img src="images/logo.png" /></a>
				<span class="tagline">A dictionary for panhuman image-based language</span>
			</header>
			<article id="content">
				<section id="instruction">
					<p>Help define this symbol:</p>
					<div class="term">
					</div>
					<p>Click to remove images that do not define the above term.</p>
				</section>
				<section id="entry">
					<ol id="defContainer">
						
					</ol>
					<h2>Usage & Context:</h2>
					<ol id="contextContainer">
						
					</ol>
				</section>
				<section id="decision">
					<div id="accept">
						<a class="accept" href="#">Accept this definition</a>
					</div>
					<div id="deny">
						<a class="deny" href="#">Throw away this term</a>
					</div>
				</section>
			</article>
		</div>
	</body>
</html>